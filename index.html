<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prime Axis Estate - Financial Strategy Simulator</title>
    
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0f172a', // Navy Dark (Slate 900)
                        secondary: '#334155', // Slate 700
                        accent: '#d97706', // Amber 600 (Gold)
                        success: '#15803d', // Emerald 700
                        danger: '#b91c1c', // Red 700
                        light: '#f1f5f9', // Slate 100
                    }
                }
            }
        }
    </script>
    
    <!-- 2. Load React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. Load Dependencies -->
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.10.3/umd/Recharts.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: 'Sarabun', 'Noto Sans SC', sans-serif, -apple-system, system-ui; background-color: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #e2e8f0; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #64748b; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .traffic-light { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .card { background: white; border: 1px solid #e2e8f0; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); overflow: hidden; page-break-inside: avoid; }
        .card-header { padding: 1rem 1.25rem; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; background: #fff; }
        .card-title { font-weight: 700; font-size: 0.9rem; color: #334155; display: flex; align-items: center; gap: 0.5rem; text-transform: uppercase; letter-spacing: 0.025em; }
        
        @media print {
            body { background-color: white; -webkit-print-color-adjust: exact; }
            .no-print { display: none !important; }
            .card { box-shadow: none; border: 1px solid #cbd5e1; margin-bottom: 20px; break-inside: avoid; }
            .max-w-7xl { max-width: 100%; padding: 0; }
            .grid { display: block; }
            .xl\:col-span-3, .xl\:col-span-4, .xl\:col-span-5 { width: 100%; margin-bottom: 20px; }
            .bg-primary { background-color: #0f172a !important; color: white !important; }
        }
    </style>
</head>
<body class="text-slate-800">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { LineChart, Line, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, PieChart, Pie, Cell, AreaChart, Area, ComposedChart } = Recharts;

        // Icons
        const Icon = ({ path, size = 18, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} dangerouslySetInnerHTML={{ __html: path }} />
        );
        const icons = {
            activity: '<path d="M22 12h-4l-3 9L9 3l-3 9H2"/>',
            home: '<path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/>',
            users: '<path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>',
            fileText: '<path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/>',
            pieChart: '<path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/>',
            table: '<path d="M12 3v18"/><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M3 9h18"/><path d="M3 15h18"/>',
            refreshCw: '<path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/>',
            trendingUp: '<polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/>',
            settings: '<circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>',
            target: '<circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/>',
            banknote: '<rect width="20" height="12" x="2" y="6" rx="2"/><circle cx="12" cy="12" r="2"/><path d="M6 12h.01M18 12h.01"/>',
            clock: '<circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>',
            briefcase: '<rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>',
            megaphone: '<path d="m3 11 18-5v12L3 14v-3z"/><path d="M11.6 16.8a3 3 0 1 1-5.8-1.6"/>',
            download: '<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/>',
            reset: '<path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/>',
            fileSpreadsheet: '<path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M8 13h2"/><path d="M8 17h2"/><path d="M14 13h2"/><path d="M14 17h2"/>',
            building2: '<path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z"/><path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"/><path d="M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2"/><path d="M10 6h4"/><path d="M10 10h4"/><path d="M10 14h4"/><path d="M10 18h4"/>',
            printer: '<polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/>',
            award: '<circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/>',
        };

        const translations = {
            th: {
                appTitle: "Prime Axis Estate",
                appSubtitle: "Financial Strategy Simulator",
                netProfitY1: "กำไรสุทธิ (ปี 1) / Net Profit Y1",
                roi: "ROI / ผลตอบแทน",
                netMargin: "Net Margin",
                cashRunway: "Cash Runway",
                payback: "Payback Period",
                totalRoas: "Total ROAS",
                months: "เดือน",
                scenarioAnalysis: "Scenario Analysis (วิเคราะห์สถานการณ์)",
                salesVolAdj: "ปรับยอดขาย (Sales Vol)",
                adBudgetAdj: "งบโฆษณา (Ad Budget)",
                vatRateAdj: "VAT Rate",
                capex: "งบลงทุน (CAPEX)",
                initialCapital: "ทุนจดทะเบียน",
                regCost: "จดทะเบียน (Registration)",
                officeSetup: "ตกแต่งสนง. (Office Setup)",
                itEquip: "อุปกรณ์ IT (IT Equip)",
                techSys: "ระบบ Tech (System)",
                launchCost: "เปิดตัว/ตลาด (Launch)",
                workingCapital: "Working Capital (เงินหมุนเวียน)",
                revenue: "รายได้ (Revenue)",
                vatMode: "VAT",
                vatInc: "ในตัว (Inc)",
                vatExc: "แยก (Exc)",
                sales: "ขาย (Sales)",
                unitMo: "Unit/Mo",
                price: "Price",
                commPct: "Comm (%)",
                rentals: "เช่า (Rentals)",
                caseMo: "Case/Mo",
                commMo: "Comm (Mo)",
                propMgmt: "บริหาร (Prop Mgmt)",
                units: "Units",
                feeMo: "Fee/Mo",
                costsStaff: "ต้นทุน & คน (Cost & Staff)",
                manager: "ผู้จัดการ (Manager)",
                teamSales: "ทีมขาย (Sales)",
                admin: "แอดมิน (Admin)",
                listing: "Listing",
                content: "Content",
                adsBudget: "Ads Budget",
                officeRent: "Office Rent",
                software: "Software",
                other: "Other",
                commissionPct: "สัดส่วนคอมฯ (Commission %)",
                companyAuto: "Company (Auto)",
                revenueFlow: "Revenue Flow (Monthly)",
                totalGross: "1. ยอดรับรวม (Total Gross)",
                deductVat: "หัก VAT",
                netRevenue: "2. ยอดสุทธิ (Net Revenue)",
                companyShare: "รายรับบริษัท (Company)",
                totalExpenses: "- ค่าใช้จ่ายรวม (Expenses)",
                monthlyNetProfit: "= กำไรสุทธิ/ด. (Net Profit)",
                corpTax: "ภาษีนิติบุคคล (Corporate Tax)",
                ebt: "กำไรสุทธิก่อนภาษี",
                netProfitRange: "ช่วงกำไร (Net Profit)",
                rate: "อัตรา",
                taxPayable: "ภาษีที่ต้องจ่าย",
                totalTax: "รวมภาษีทั้งสิ้น (Total Tax)",
                marketingFunnel: "Marketing Funnel & Budget",
                salesBudget: "Sales Budget",
                rentBudget: "Rent Budget",
                salesSide: "ฝั่งขาย (Sales)",
                cpl: "CPL (Cost/Lead)",
                convRate: "Conv. Rate %",
                leads: "Leads",
                closed: "Closed",
                roas: "ROAS",
                rentSide: "ฝั่งเช่า (Rentals)",
                netIncomeMix: "รายได้สุทธิบริษัท (Net Income Mix)",
                expenseSplit: "สัดส่วนค่าใช้จ่าย (Expenses)",
                breakeven: "จุดคุ้มทุน (Break-Even)",
                minRevenue: "รายได้รวมขั้นต่ำที่ต้องการ/เดือน",
                mustSell: "ต้องขายบ้าน (Sales)",
                mustRent: "หรือ ต้องปล่อยเช่า (Rentals)",
                cashFlow12: "กระแสเงินสด 12 เดือน (Operating Cash Flow)",
                growth: "Growth",
                month: "เดือน (Month)",
                netIn: "รายได้สุทธิ",
                exp: "ค่าใช้จ่าย",
                profit: "กำไรก่อนภาษี (EBT)",
                tax: "ภาษี (Tax)",
                netP: "กำไรสุทธิ (Net)",
                cash: "เงินสดสะสม (Cash)",
                start: "Start",
                totalY1: "รวมปี 1",
                dividendPolicy: "นโยบายปันผล (Dividend Policy)",
                payout: "Payout",
                totalDiv: "เงินปันผลรวม (Total Dividend)",
                paidFromY1: "จ่ายจากกำไรสุทธิปีที่ 1",
                founderShare: "ต่อคน/ปี (Founder Share)",
                for2Founders: "สำหรับผู้ก่อตั้ง 2 ท่าน",
                monthlyAvg: "เฉลี่ยต่อเดือน (Monthly Avg)",
                sideIncome: "รายได้เสริมต่อคน",
                projection5Y: "5-Year Projection (ประมาณการ 5 ปี)",
                inflation: "Inflation",
                year: "Year",
                revenue5y: "Revenue",
                expense5y: "Expense",
                ebt5y: "EBT",
                tax5y: "Tax",
                net5y: "Net Profit",
                div5y: "Dividend",
                cashEnd: "Cash End",
                base: "Base",
                reset: "Reset",
                print: "Print",
                unitEcon: "Unit Econ (Sale)",
                profitPerTrans: "Profit per Transaction",
                rentPerDeal: "Rent",
                deal: "Deal",
                worst: "แย่สุด",
                baseCase: "ปกติ",
                best: "ดีสุด",
                execSummary: "Executive Summary (บทสรุปผู้บริหาร)",
                assumptions: "*สมมติฐาน: รายได้เติบโตตามอัตราที่เลือก (Growth), ค่าใช้จ่ายเพิ่มขึ้นตามเงินเฟ้อ (Inflation) ต่อปี",
                scoreTitle: "Business Viability Score (คะแนนความเป็นไปได้)",
                scoreGrade: "เกรด",
                scoreDetails: "รายละเอียดการให้คะแนน",
                risk: "ความเสี่ยง",
                viability: "ความเป็นไปได้",
                totalCapex: "รวมงบลงทุน (Total CAPEX)"
            },
            cn: {
                appTitle: "Prime Axis Estate",
                appSubtitle: "财务战略模拟器 (Financial Strategy Simulator)",
                netProfitY1: "净利润 (第一年)",
                roi: "投资回报率 (ROI)",
                netMargin: "净利率 (Net Margin)",
                cashRunway: "资金维持期 (Cash Runway)",
                payback: "回本期 (Payback)",
                totalRoas: "总广告回报率 (Total ROAS)",
                months: "个月",
                scenarioAnalysis: "情景分析 (Scenario Analysis)",
                salesVolAdj: "销售量调整 (Sales Vol)",
                adBudgetAdj: "广告预算 (Ad Budget)",
                vatRateAdj: "增值税率 (VAT Rate)",
                capex: "资本支出 (CAPEX)",
                initialCapital: "注册资本",
                regCost: "注册费 (Registration)",
                officeSetup: "办公室装修 (Office Setup)",
                itEquip: "IT设备 (IT Equip)",
                techSys: "技术系统 (System)",
                launchCost: "开业/营销 (Launch)",
                workingCapital: "营运资金 (Working Capital)",
                revenue: "收入 (Revenue)",
                vatMode: "增值税",
                vatInc: "含税 (Inc)",
                vatExc: "未含 (Exc)",
                sales: "销售 (Sales)",
                unitMo: "套/月",
                price: "价格",
                commPct: "佣金 (%)",
                rentals: "租赁 (Rentals)",
                caseMo: "单/月",
                commMo: "佣金 (月)",
                propMgmt: "物业管理 (Prop Mgmt)",
                units: "套数",
                feeMo: "费用/月",
                costsStaff: "成本与人员 (Cost & Staff)",
                manager: "经理 (Manager)",
                teamSales: "销售团队 (Sales)",
                admin: "行政 (Admin)",
                listing: "房源开发 (Listing)",
                content: "内容运营 (Content)",
                adsBudget: "广告预算",
                officeRent: "办公室租金",
                software: "软件费",
                other: "其他",
                commissionPct: "佣金分配 (%)",
                companyAuto: "公司留存 (自动)",
                revenueFlow: "收入流向 (月度)",
                totalGross: "1. 总收入 (Total Gross)",
                deductVat: "扣除增值税",
                netRevenue: "2. 净收入 (Net Revenue)",
                companyShare: "公司收入 (Company)",
                totalExpenses: "- 总支出 (Expenses)",
                monthlyNetProfit: "= 月度净利润 (Net Profit)",
                corpTax: "企业所得税 (Corporate Tax)",
                ebt: "税前利润 (EBT)",
                netProfitRange: "净利润区间",
                rate: "税率",
                taxPayable: "应纳税额",
                totalTax: "总税额 (Total Tax)",
                marketingFunnel: "营销漏斗与预算",
                salesBudget: "销售预算",
                rentBudget: "租赁预算",
                salesSide: "销售端 (Sales)",
                cpl: "单客成本 (CPL)",
                convRate: "转化率 %",
                leads: "线索数",
                closed: "成交数",
                roas: "回报率 (ROAS)",
                rentSide: "租赁端 (Rentals)",
                netIncomeMix: "公司净收入构成 (Net Income Mix)",
                expenseSplit: "支出比例 (Expenses)",
                breakeven: "盈亏平衡点 (Break-Even)",
                minRevenue: "最低月收入要求",
                mustSell: "需销售 (Sales)",
                mustRent: "或需出租 (Rentals)",
                cashFlow12: "12个月现金流 (Operating Cash Flow)",
                growth: "增长率",
                month: "月份",
                netIn: "净收入",
                exp: "支出",
                profit: "税前利润",
                tax: "税费",
                netP: "净利润",
                cash: "累计现金",
                start: "初始",
                totalY1: "第一年总计",
                dividendPolicy: "分红政策 (Dividend Policy)",
                payout: "分红比例",
                totalDiv: "总分红 (Total Dividend)",
                paidFromY1: "从第一年净利支付",
                founderShare: "每人/年 (Founder Share)",
                for2Founders: "两位创始人",
                monthlyAvg: "月均 (Monthly Avg)",
                sideIncome: "每人额外收入",
                projection5Y: "5年财务预测 (5-Year Projection)",
                inflation: "通胀率",
                year: "年份",
                revenue5y: "收入",
                expense5y: "支出",
                ebt5y: "税前利润",
                tax5y: "税费",
                net5y: "净利润",
                div5y: "分红",
                cashEnd: "期末现金",
                base: "基准",
                reset: "重置",
                print: "打印",
                unitEcon: "单笔效益 (销售)",
                profitPerTrans: "每笔交易利润",
                rentPerDeal: "租赁",
                deal: "单",
                worst: "最差",
                baseCase: "正常",
                best: "最好",
                execSummary: "执行摘要 (Executive Summary)",
                assumptions: "*假设: 收入按选定增长率 (Growth) 增长, 支出按通胀率 (Inflation) 每年增加",
                scoreTitle: "业务可行性评分 (Business Viability Score)",
                scoreGrade: "等级",
                scoreDetails: "评分详情",
                risk: "风险",
                viability: "可行性",
                totalCapex: "总资本支出 (Total CAPEX)"
            }
        };

        const DEFAULT_INPUTS = {
            vatMode: 'include', growthRate: 0, annualGrowthRate: 15, inflationRate: 5, 
            initialCapital: 2000000, capexRegistration: 20000, capexOffice: 120000, capexEquipment: 100000, capexTech: 60000, capexLaunch: 50000,
            avgHousePrice: 7000000, salesVolume: 3, salesCommRate: 5,              
            rentalVolume: 7, avgRentalPrice: 50000, rentalCommMonths: 1,   
            pmUnits: 0, pmFeePerUnit: 2000,
            marketingBudget: 100000, officeRent: 35000, softwareCost: 10000, otherExpenses: 0, 
            salaryManagerRate: 30000, salaryManagerCount: 1, salarySalesRate: 18000, salarySalesCount: 2, salaryAdminRate: 15000, salaryAdminCount: 1, salaryListingRate: 15000, salaryListingCount: 1, salaryContentRate: 15000, salaryContentCount: 1,
            shareSales: 30, shareListing: 2.5, shareAdmin: 2.5, shareManager: 0, shareContent: 0,
            marketingSplitPct: 70, cplSale: 400, cplRent: 200, qualifyRateSale: 20, qualifyRateRent: 25, closeRateSale: 10, closeRateRent: 20,
            sensAdBudget: 0, sensSalesVol: 0, sensVatRate: 7,
            newHires: 0, avgNewSalary: 20000, dividendRate: 50,
        };

        const FinancialDashboard = () => {
            // Load state from local storage or use defaults
            const [inputs, setInputs] = useState(() => {
                const saved = localStorage.getItem('primeAxisInputs');
                return saved ? JSON.parse(saved) : DEFAULT_INPUTS;
            });
            const [lang, setLang] = useState('th'); // Language State
            const t = translations[lang]; // Current translation

            useEffect(() => {
                localStorage.setItem('primeAxisInputs', JSON.stringify(inputs));
            }, [inputs]);

            const resetToDefaults = () => {
                if(confirm('คุณต้องการรีเซ็ตค่าทั้งหมดกลับเป็นค่าเริ่มต้นหรือไม่?')) {
                    setInputs(DEFAULT_INPUTS);
                }
            };

            const [results, setResults] = useState({
                totalCapex: 0, workingCapital: 0, totalGross: 0, vatAmount: 0, netRevenue: 0,
                distSales: 0, distListing: 0, distAdmin: 0, distManager: 0, distContent: 0, distCompany: 0,
                totalExpenses: 0, annualNetProfit: 0, roi: 0, paybackPeriod: 0, breakEvenPoint: 0,
                taxDetails: [], totalTax: 0, monthlyEBT: 0, annualEBT: 0, totalSalaries: 0,
                companySharePercent: 0,
                kpi: { netMargin: { val: 0, status: 'good' }, runway: { val: 0, status: 'good' } }, 
                runwayMonths: 0, 
                marketing: { sales: {}, rent: {}, totalROAS: 0 }, 
                dividends: { total: 0, perFounderYear: 0, perFounderMonth: 0, cumulative5Year: 0 }, 
                headcountImpact: { diffProfit: 0 },
                year1RevenueSum: 0, year1ExpenseSum: 0, finalCashBalance: 0,
                unitEconomics: { sales: 0, rental: 0 },
                pmIncome: 0,
                executiveSummary: "",
                score: { total: 0, grade: 'F', details: [] }
            });

            const [cashFlowData, setCashFlowData] = useState([]);
            const [fiveYearData, setFiveYearData] = useState([]);
            const [expensePieData, setExpensePieData] = useState([]);
            const [revenuePieData, setRevenuePieData] = useState([]);
            const [bepChartData, setBepChartData] = useState([]);

            const calculateTax = (annualEBT) => {
                let tax = 0;
                if (annualEBT > 3000000) { tax += (annualEBT - 3000000) * 0.20; tax += 2700000 * 0.15; } 
                else if (annualEBT > 300000) { tax += (annualEBT - 300000) * 0.15; }
                return tax < 0 ? 0 : tax;
            }

            // Export to CSV Function
            const downloadCSV = () => {
                let csvContent = "data:text/csv;charset=utf-8,";
                // Add BOM for Excel to read UTF-8 correctly
                csvContent += "\uFEFF"; 

                // 1. Executive Summary
                csvContent += "Executive Summary\n";
                csvContent += `"${results.executiveSummary}"\n\n`;

                // 2. Key Metrics
                csvContent += "Key Metrics,Value\n";
                csvContent += `Net Profit (Year 1),${results.annualNetProfit}\n`;
                csvContent += `ROI,${results.roi.toFixed(2)}%\n`;
                csvContent += `Payback Period (Months),${results.paybackPeriod.toFixed(2)}\n`;
                csvContent += `Cash Runway (Months),${results.runwayMonths.toFixed(2)}\n\n`;

                // 3. 12-Month Cash Flow
                csvContent += "12-Month Cash Flow\n";
                csvContent += "Month,Net Revenue,Expenses,Net Profit,Cumulative Cash\n";
                cashFlowData.forEach(row => {
                    csvContent += `${row.month},${row.revenue},${row.expenses},${row.net},${row.cumulative}\n`;
                });
                csvContent += "\n";

                // 4. 5-Year Projection
                csvContent += "5-Year Projection\n";
                csvContent += "Year,Revenue,Expenses,EBT,Tax,Net Profit,Dividend,Cash End\n";
                fiveYearData.forEach(row => {
                    csvContent += `${row.year},${row.revenue},${row.expenses},${row.ebt},${row.tax},${row.netProfit},${row.dividend},${row.cashEnd}\n`;
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "PrimeAxis_Financial_Plan.csv");
                document.body.appendChild(link);
                link.click();
            };

            const applyScenario = (type) => {
                if (type === 'base') {
                    setInputs(prev => ({ ...prev, sensSalesVol: 0, sensAdBudget: 0, sensVatRate: 7 }));
                } else if (type === 'worst') {
                    setInputs(prev => ({ ...prev, sensSalesVol: -30, sensAdBudget: 10, sensVatRate: 7 }));
                } else if (type === 'best') {
                    setInputs(prev => ({ ...prev, sensSalesVol: 20, sensAdBudget: 0, sensVatRate: 7 }));
                }
            };

            useEffect(() => {
                const adjSalesVolume = inputs.salesVolume * (1 + inputs.sensSalesVol/100);
                const adjRentalVolume = inputs.rentalVolume * (1 + inputs.sensSalesVol/100);
                const adjMarketingBudget = inputs.marketingBudget * (1 + inputs.sensAdBudget/100);
                const currentVatRate = inputs.sensVatRate / 100;
                const vatDivisor = 1 + currentVatRate;

                // CAPEX
                const totalCapex = inputs.capexRegistration + inputs.capexOffice + inputs.capexEquipment + inputs.capexTech + inputs.capexLaunch;
                const workingCapital = inputs.initialCapital - totalCapex;

                // REVENUE
                const salesBase = inputs.avgHousePrice * adjSalesVolume * (inputs.salesCommRate / 100);
                const rentalBase = inputs.avgRentalPrice * adjRentalVolume * inputs.rentalCommMonths;
                const pmBase = inputs.pmUnits * inputs.pmFeePerUnit; // Recurring
                const baseRevenue = salesBase + rentalBase + pmBase;

                // VAT Logic
                let totalGross, netRevenue, vatAmount, salesNet, rentalNet, pmNet;
                if (inputs.vatMode === 'include') {
                    totalGross = baseRevenue;
                    netRevenue = totalGross / vatDivisor;
                    vatAmount = totalGross - netRevenue;
                    salesNet = salesBase / vatDivisor;
                    rentalNet = rentalBase / vatDivisor;
                    pmNet = pmBase / vatDivisor;
                } else {
                    netRevenue = baseRevenue;
                    vatAmount = netRevenue * currentVatRate;
                    totalGross = netRevenue + vatAmount;
                    salesNet = salesBase;
                    rentalNet = rentalBase;
                    pmNet = pmBase;
                }

                // DISTRIBUTION
                const companySharePercent = 100 - inputs.shareSales - inputs.shareListing - inputs.shareAdmin - inputs.shareManager - inputs.shareContent;
                
                const distSales = netRevenue * (inputs.shareSales / 100);
                const distListing = netRevenue * (inputs.shareListing / 100);
                const distAdmin = netRevenue * (inputs.shareAdmin / 100);
                const distManager = netRevenue * (inputs.shareManager / 100);
                const distContent = netRevenue * (inputs.shareContent / 100);
                const distCompany = netRevenue * (companySharePercent / 100);

                const salesCompanyIncome = salesNet * (companySharePercent / 100);
                const rentalCompanyIncome = rentalNet * (companySharePercent / 100);
                const pmCompanyIncome = pmNet * (companySharePercent / 100);

                // UNIT ECONOMICS
                const unitSaleBase = inputs.avgHousePrice * (inputs.salesCommRate / 100);
                const unitRentBase = inputs.avgRentalPrice * inputs.rentalCommMonths;
                let unitSaleNet = inputs.vatMode === 'include' ? unitSaleBase / vatDivisor : unitSaleBase;
                let unitRentNet = inputs.vatMode === 'include' ? unitRentBase / vatDivisor : unitRentBase;
                const unitSaleProfit = unitSaleNet * (companySharePercent / 100);
                const unitRentProfit = unitRentNet * (companySharePercent / 100);

                // EXPENSES
                const currentSalaries = 
                    (inputs.salaryManagerRate * inputs.salaryManagerCount) +
                    (inputs.salarySalesRate * inputs.salarySalesCount) +
                    (inputs.salaryAdminRate * inputs.salaryAdminCount) +
                    (inputs.salaryListingRate * inputs.salaryListingCount) +
                    (inputs.salaryContentRate * inputs.salaryContentCount);
                const additionalSalaries = inputs.newHires * inputs.avgNewSalary;
                const totalSalaries = currentSalaries + additionalSalaries;
                const fixedCosts = totalSalaries + inputs.officeRent + inputs.softwareCost + inputs.otherExpenses;
                const totalExpenses = fixedCosts + adjMarketingBudget;

                // PROFIT
                const monthlyEBT = distCompany - totalExpenses;
                
                // 12-MONTH SIMULATION
                const cfData = [];
                const bepData = [];
                let currentCash = workingCapital; 
                let cumulativeRev = 0;
                let cumulativeExp = 0;
                let cumulativeEBT = 0;

                for (let i = 1; i <= 12; i++) {
                    const growthFactor = Math.pow(1 + (inputs.growthRate / 100), i - 1);
                    const mNetRevenue = netRevenue * growthFactor; 
                    const mDistCompany = mNetRevenue * (companySharePercent / 100);
                    const mFlow = mDistCompany - totalExpenses; 
                    currentCash += mFlow;
                    cumulativeRev += mDistCompany;
                    cumulativeExp += totalExpenses;
                    cumulativeEBT += mFlow;
                    cfData.push({ month: i, revenue: mDistCompany, expenses: totalExpenses, net: mFlow, cumulative: currentCash });
                    bepData.push({ month: `M${i}`, revenue: cumulativeRev, expenses: cumulativeExp });
                }

                const annualEBTReal = cumulativeEBT;
                let tax = calculateTax(annualEBTReal);
                const annualNetProfit = annualEBTReal - tax;
                const year1CashEnd = cfData[11].cumulative - tax; 
                const roi = (annualNetProfit / inputs.initialCapital) * 100;
                let paybackPeriod = annualNetProfit > 0 ? inputs.initialCapital / (annualNetProfit/12) : Infinity;

                // DIVIDEND
                const dividendPool = annualNetProfit > 0 ? annualNetProfit * (inputs.dividendRate / 100) : 0;
                const year1CashAfterDiv = year1CashEnd - dividendPool;

                // 5-YEAR PROJECTION
                const fiveYear = [];
                let prevYearCash = year1CashAfterDiv;
                const y1RevTotal = cfData.reduce((acc, c) => acc + c.revenue, 0);
                const y1ExpTotal = totalExpenses * 12;
                let cumDiv = dividendPool;

                fiveYear.push({ 
                    year: 1, revenue: y1RevTotal, expenses: y1ExpTotal, ebt: annualEBTReal, 
                    tax: tax, netProfit: annualNetProfit, dividend: dividendPool, cashEnd: prevYearCash 
                });

                const annualGrowth = inputs.annualGrowthRate / 100;
                const inflationRate = inputs.inflationRate / 100;

                for (let y = 2; y <= 5; y++) {
                    const rev = fiveYear[y-2].revenue * (1 + annualGrowth);
                    const exp = fiveYear[y-2].expenses * (1 + inflationRate);
                    const ebt = rev - exp;
                    const yTax = calculateTax(ebt);
                    const net = ebt - yTax;
                    const div = net > 0 ? net * (inputs.dividendRate / 100) : 0;
                    cumDiv += div;
                    const cash = prevYearCash + net - div;
                    fiveYear.push({ year: y, revenue: rev, expenses: exp, ebt: ebt, tax: yTax, netProfit: net, dividend: div, cashEnd: cash });
                    prevYearCash = cash;
                }

                // Marketing
                const salesBudget = adjMarketingBudget * (inputs.marketingSplitPct / 100);
                const rentBudget = adjMarketingBudget * ((100 - inputs.marketingSplitPct) / 100);
                const leadsS = salesBudget / inputs.cplSale;
                const qualS = leadsS * (inputs.qualifyRateSale / 100);
                const closedS = qualS * (inputs.closeRateSale / 100);
                const revS = closedS * unitSaleNet; 
                const leadsR = rentBudget / inputs.cplRent;
                const qualR = leadsR * (inputs.qualifyRateRent / 100);
                const closedR = qualR * (inputs.closeRateRent / 100);
                const revR = closedR * unitRentNet;
                const marketingStats = {
                    sales: { budget: salesBudget, leads: leadsS, qual: qualS, closed: closedS, rev: revS, roas: revS/salesBudget || 0, cpa: salesBudget/closedS || 0 },
                    rent: { budget: rentBudget, leads: leadsR, qual: qualR, closed: closedR, rev: revR, roas: revR/rentBudget || 0, cpa: rentBudget/closedR || 0 },
                    totalROAS: adjMarketingBudget>0 ? (revS + revR) / adjMarketingBudget : 0
                };

                let breakEvenRevenue = 0;
                if (companySharePercent > 0) {
                    const netRevenueNeeded = totalExpenses / (companySharePercent / 100);
                    breakEvenRevenue = inputs.vatMode === 'include' ? netRevenueNeeded * vatDivisor : netRevenueNeeded;
                }
                const netMargin = (monthlyEBT / (distCompany || 1)) * 100;
                const runwayMonths = currentCash > 0 ? currentCash / totalExpenses : 0;

                let taxDetails = [];
                let t1Base = Math.min(annualEBTReal, 300000); if(t1Base<0) t1Base=0;
                taxDetails.push({ tier: '0 - 300,000', rate: '0%', base: t1Base, tax: 0 });
                let t2Base = 0, t2Tax = 0;
                if (annualEBTReal > 300000) { t2Base = Math.min(annualEBTReal - 300000, 2700000); t2Tax = t2Base * 0.15; }
                taxDetails.push({ tier: '300,001 - 3M', rate: '15%', base: t2Base, tax: t2Tax });
                let t3Base = 0, t3Tax = 0;
                if (annualEBTReal > 3000000) { t3Base = annualEBTReal - 3000000; t3Tax = t3Base * 0.20; }
                taxDetails.push({ tier: '> 3,000,000', rate: '20%', base: t3Base, tax: t3Tax });

                // EXECUTIVE SUMMARY LOGIC
                let execSummary = "สถานะธุรกิจ: ";
                if (runwayMonths > 12 && roi > 20) execSummary += "แข็งแกร่งมาก (Strong) ";
                else if (runwayMonths > 6) execSummary += "ปานกลาง (Stable) ";
                else execSummary += "น่าเป็นห่วง (Risky) ";
                
                execSummary += `| กระแสเงินสดเพียงพอ ${runwayMonths.toFixed(1)} เดือน | `;
                execSummary += annualNetProfit > 0 ? "มีกำไรสุทธิ" : "ขาดทุนสุทธิ";
                execSummary += ` | ROAS: ${marketingStats.totalROAS.toFixed(1)}x`;

                // --- SCORING ALGORITHM ---
                let score = 0;
                let scoreDetails = [];

                // 1. Profitability (Max 30) - Net Margin
                let scoreProfit = 0;
                if (netMargin >= 20) scoreProfit = 30;
                else if (netMargin >= 15) scoreProfit = 25;
                else if (netMargin >= 10) scoreProfit = 20;
                else if (netMargin > 0) scoreProfit = 10;
                score += scoreProfit;
                scoreDetails.push({ name: 'Net Margin', score: scoreProfit, max: 30, val: `${netMargin.toFixed(1)}%` });

                // 2. Safety / Runway (Max 30) - Cash Runway
                let scoreRunway = 0;
                if (workingCapital < 0) scoreRunway = 0; // Negative initial is terrible
                else if (runwayMonths >= 18) scoreRunway = 30;
                else if (runwayMonths >= 12) scoreRunway = 25;
                else if (runwayMonths >= 6) scoreRunway = 15;
                else if (runwayMonths >= 3) scoreRunway = 5;
                score += scoreRunway;
                scoreDetails.push({ name: 'Cash Runway', score: scoreRunway, max: 30, val: `${runwayMonths.toFixed(1)} mo` });

                // 3. Efficiency (Max 20) - ROAS
                let scoreEff = 0;
                const roasVal = marketingStats.totalROAS;
                if (roasVal >= 8) scoreEff = 20;
                else if (roasVal >= 5) scoreEff = 15;
                else if (roasVal >= 3) scoreEff = 10;
                else if (roasVal >= 1) scoreEff = 5;
                score += scoreEff;
                scoreDetails.push({ name: 'Marketing ROAS', score: scoreEff, max: 20, val: `${roasVal.toFixed(1)}x` });

                // 4. Attractiveness (Max 20) - ROI
                let scoreRoi = 0;
                if (roi >= 50) scoreRoi = 20;
                else if (roi >= 25) scoreRoi = 15;
                else if (roi >= 10) scoreRoi = 10;
                else if (roi > 0) scoreRoi = 5;
                score += scoreRoi;
                scoreDetails.push({ name: 'ROI (Year 1)', score: scoreRoi, max: 20, val: `${roi.toFixed(1)}%` });

                // Grade
                let grade = 'F';
                if (score >= 80) grade = 'A';
                else if (score >= 70) grade = 'B';
                else if (score >= 50) grade = 'C';
                else if (score >= 30) grade = 'D';

                setResults({
                    totalCapex, workingCapital, totalGross, vatAmount, netRevenue,
                    distSales, distListing, distAdmin, distManager, distContent, distCompany,
                    totalExpenses, annualNetProfit, roi, paybackPeriod, breakEvenPoint: breakEvenRevenue,
                    totalTax: tax, monthlyEBT, annualEBT: annualEBTReal, totalSalaries, companySharePercent,
                    kpi: { netMargin: { val: netMargin, status: netMargin > 20 ? 'good' : netMargin > 0 ? 'warning' : 'bad' }, runway: { val: runwayMonths, status: runwayMonths > 12 ? 'good' : runwayMonths > 6 ? 'warning' : 'bad' } },
                    runwayMonths, marketing: marketingStats, 
                    dividends: { total: dividendPool, perFounderYear: dividendPool / 2, perFounderMonth: (dividendPool / 2) / 12, cumulative5Year: cumDiv },
                    headcountImpact: { diffProfit: -additionalSalaries },
                    year1RevenueSum: y1RevTotal, year1ExpenseSum: y1ExpTotal, finalCashBalance: year1CashEnd,
                    taxDetails: taxDetails,
                    unitEconomics: { sales: unitSaleProfit, rental: unitRentProfit },
                    pmIncome: pmBase,
                    executiveSummary: execSummary,
                    score: { total: score, grade, details: scoreDetails }
                });
                setFiveYearData(fiveYear);
                setCashFlowData(cfData);
                setBepChartData(bepData);
                setExpensePieData([{ name: 'เงินเดือน (Salary)', value: totalSalaries }, { name: 'การตลาด (Ads)', value: adjMarketingBudget }, { name: 'ค่าเช่า (Rent)', value: inputs.officeRent }, { name: 'Software', value: inputs.softwareCost }, { name: 'อื่นๆ (Other)', value: inputs.otherExpenses }]);
                setRevenuePieData([{ name: 'ขาย (Sales)', value: salesCompanyIncome }, { name: 'เช่า (Rentals)', value: rentalCompanyIncome }, { name: 'บริหาร (PM)', value: pmCompanyIncome }]);
            }, [inputs]);

            const handleInputChange = (e) => setInputs(prev => ({ ...prev, [e.target.name]: parseFloat(e.target.value) || 0 }));
            const toggleVatMode = () => setInputs(prev => ({ ...prev, vatMode: prev.vatMode === 'include' ? 'exclude' : 'include' }));
            const formatCurrency = (num) => new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB', maximumFractionDigits: 0 }).format(num || 0);
            const formatNum = (num) => new Intl.NumberFormat('th-TH', { maximumFractionDigits: 1 }).format(num || 0);
            const COLORS = { chart: ['#0f172a', '#d97706', '#64748b', '#059669', '#be123c'], revenue: ['#3b82f6', '#f59e0b', '#8b5cf6'] };
            
            const capexItems = [{ label: 'regCost', name: 'capexRegistration' }, { label: 'officeSetup', name: 'capexOffice' }, { label: 'itEquip', name: 'capexEquipment' }, { label: 'techSys', name: 'capexTech' }, { label: 'launchCost', name: 'capexLaunch' }];
            const staffRoles = [ { id: 'Manager', label: 'manager', rateKey: 'salaryManagerRate', countKey: 'salaryManagerCount' }, { id: 'Sales', label: 'teamSales', rateKey: 'salarySalesRate', countKey: 'salarySalesCount' }, { id: 'Admin', label: 'admin', rateKey: 'salaryAdminRate', countKey: 'salaryAdminCount' }, { id: 'Listing', label: 'listing', rateKey: 'salaryListingRate', countKey: 'salaryListingCount' }, { id: 'Content', label: 'content', rateKey: 'salaryContentRate', countKey: 'salaryContentCount' } ];

            // Score Color Helper
            const getScoreColor = (s) => s >= 80 ? 'text-emerald-600' : s >= 60 ? 'text-blue-600' : s >= 40 ? 'text-amber-500' : 'text-red-600';
            const getGradeBg = (g) => g === 'A' ? 'bg-emerald-100 text-emerald-800 border-emerald-200' : g === 'B' ? 'bg-blue-100 text-blue-800 border-blue-200' : g === 'C' ? 'bg-amber-100 text-amber-800 border-amber-200' : 'bg-red-100 text-red-800 border-red-200';

            return (
                <div className="bg-slate-100 min-h-screen font-sans text-slate-800 pb-10">
                    <div className="bg-primary text-white p-5 shadow-lg mb-8 no-print">
                        <div className="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center">
                            <div className="flex items-center gap-3">
                                <div className="bg-white/10 p-2 rounded-lg"><Icon path={icons.activity} size={24} className="text-white"/></div>
                                <div><h1 className="text-2xl font-bold tracking-tight">Prime Axis Estate</h1><p className="text-sm text-slate-300">Financial Strategy Simulator</p></div>
                            </div>
                            <div className="mt-4 md:mt-0 flex gap-3 text-center items-center">
                                <div className="bg-white/10 px-5 py-2 rounded-lg backdrop-blur-md border border-white/10"><div className="text-xs text-slate-300 uppercase tracking-wide mb-1">{t.netProfitY1}</div><div className="text-2xl font-bold text-success">{formatCurrency(results.annualNetProfit)}</div></div>
                                <div className="bg-white/10 px-5 py-2 rounded-lg backdrop-blur-md border border-white/10"><div className="text-xs text-slate-300 uppercase tracking-wide mb-1">{t.roi}</div><div className="text-2xl font-bold text-accent">{results.roi?.toFixed(1)}%</div></div>
                                <div className="flex gap-1 ml-4">
                                    <button onClick={() => setLang('th')} className={`w-8 h-8 rounded-full border ${lang === 'th' ? 'bg-white text-primary border-transparent' : 'bg-transparent text-slate-400 border-slate-600'} text-xs font-bold transition-all`}>TH</button>
                                    <button onClick={() => setLang('cn')} className={`w-8 h-8 rounded-full border ${lang === 'cn' ? 'bg-white text-primary border-transparent' : 'bg-transparent text-slate-400 border-slate-600'} text-xs font-bold transition-all`}>CN</button>
                                </div>
                                <div className="ml-2 flex gap-2">
                                    <button onClick={resetToDefaults} className="bg-white/10 hover:bg-white/20 text-white p-2 rounded-lg transition-colors" title={t.reset}><Icon path={icons.refreshCw} size={18}/></button>
                                    <button onClick={downloadCSV} className="bg-success hover:bg-emerald-600 text-white p-2 rounded-lg transition-colors" title="CSV"><Icon path={icons.fileSpreadsheet} size={18}/></button>
                                    <button onClick={() => window.print()} className="bg-accent hover:bg-amber-600 text-white p-2 rounded-lg transition-colors" title={t.print}><Icon path={icons.megaphone} size={18}/></button>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* NEW: BUSINESS SCORECARD */}
                    <div className="max-w-7xl mx-auto px-4 -mt-2 mb-6 no-print">
                        <div className="card p-6 shadow-md border-t-4 border-t-indigo-500">
                            <div className="flex flex-col md:flex-row gap-8 items-center">
                                {/* Score Display */}
                                <div className="flex-none text-center">
                                    <h3 className="text-sm text-slate-500 font-bold uppercase mb-2">{t.scoreTitle}</h3>
                                    <div className="relative inline-flex items-center justify-center">
                                        <svg className="w-28 h-28 transform -rotate-90">
                                            <circle cx="56" cy="56" r="48" stroke="#f1f5f9" strokeWidth="10" fill="none" />
                                            <circle cx="56" cy="56" r="48" stroke="currentColor" strokeWidth="10" fill="none" 
                                                strokeDasharray={301} 
                                                strokeDashoffset={301 - (301 * results.score.total / 100)} 
                                                className={`transition-all duration-1000 ${getScoreColor(results.score.total)}`} 
                                            />
                                        </svg>
                                        <div className="absolute flex flex-col items-center">
                                            <span className={`text-3xl font-bold ${getScoreColor(results.score.total)}`}>{results.score.total}</span>
                                            <span className={`text-[10px] px-2 py-0.5 rounded font-bold ${getGradeBg(results.score.grade)}`}>{t.scoreGrade} {results.score.grade}</span>
                                        </div>
                                    </div>
                                </div>

                                {/* Score Details */}
                                <div className="flex-1 w-full grid grid-cols-2 lg:grid-cols-4 gap-4">
                                    {results.score.details.map((item, idx) => (
                                        <div key={idx} className="bg-slate-50 p-3 rounded-lg border border-slate-100 flex flex-col justify-between">
                                            <div className="text-xs text-slate-500 font-bold uppercase mb-1">{item.name}</div>
                                            <div className="flex justify-between items-end">
                                                <div className="text-sm font-semibold text-slate-700">{item.val}</div>
                                                <div className="text-sm font-bold text-slate-400">{item.score}/{item.max}</div>
                                            </div>
                                            <div className="w-full h-1.5 bg-slate-200 rounded-full mt-1.5">
                                                <div className={`h-full rounded-full ${item.score/item.max >= 0.7 ? 'bg-emerald-500' : item.score/item.max >= 0.4 ? 'bg-amber-400' : 'bg-red-400'}`} style={{width: `${(item.score/item.max)*100}%`}}></div>
                                            </div>
                                        </div>
                                    ))}
                                </div>

                                {/* Recommendation Text */}
                                <div className="flex-1 w-full text-sm border-l pl-6 border-slate-200 italic text-slate-600">
                                    {results.score.total < 50 ? (
                                        <div className="flex gap-2 items-start text-red-600 not-italic">
                                            <Icon path={icons.alertTriangle} className="shrink-0" />
                                            <div><span className="font-bold">{t.risk} (High Risk):</span> โมเดลนี้อาจขาดทุนหรือสายป่านไม่ยาวพอ ควรลดรายจ่ายประจำ</div>
                                        </div>
                                    ) : results.score.total < 80 ? (
                                        <div className="flex gap-2 items-start text-amber-600 not-italic">
                                            <Icon path={icons.activity} className="shrink-0" />
                                            <div><span className="font-bold">{t.viability} (Viable):</span> ธุรกิจไปได้แต่อาจเหนื่อยช่วงแรก ตรวจสอบ Cash Flow ให้ดี</div>
                                        </div>
                                    ) : (
                                        <div className="flex gap-2 items-start text-emerald-600 not-italic">
                                            <Icon path={icons.award} className="shrink-0" />
                                            <div><span className="font-bold">{t.viability} (Excellent):</span> ตัวเลขดูดีมาก มีโอกาสคืนทุนไวและกำไรสูง</div>
                                        </div>
                                    )}
                                    <p className="mt-2 text-xs text-slate-400 not-italic">* คะแนนคำนวณจาก Net Margin, ROI, Cash Runway และ ROAS ตามมาตรฐาน SME</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Executive Summary Box */}
                    <div className="max-w-7xl mx-auto px-4 mb-6 no-print">
                        <div className="bg-white border-l-4 border-accent p-4 rounded-r-lg shadow-sm flex items-start gap-3">
                            <Icon path={icons.megaphone} size={20} className="text-accent mt-0.5"/>
                            <div>
                                <h3 className="text-sm font-bold text-slate-700">{t.execSummary}</h3>
                                <p className="text-sm text-slate-600 mt-1">{results.executiveSummary}</p>
                            </div>
                        </div>
                    </div>

                    <div className="max-w-7xl mx-auto px-4 -mt-2 mb-8 grid grid-cols-2 md:grid-cols-5 gap-4 no-print">
                        <div className="card p-4 flex flex-col justify-between border-t-4 border-success" title="(Net Profit / Net Revenue) * 100">
                            <div className="flex items-center gap-2 mb-1"><span className={`traffic-light ${results.kpi.netMargin?.status==='good'?'bg-success':results.kpi.netMargin?.status==='warning'?'bg-accent':'bg-danger'}`}></span><span className="text-xs text-slate-500 font-bold uppercase">{t.netMargin}</span></div>
                            <div className="text-2xl font-bold text-slate-700">{results.kpi.netMargin?.val?.toFixed(1)}%</div>
                        </div>
                        <div className="card p-4 flex flex-col justify-between border-t-4 border-accent">
                            <div className="flex items-center gap-2 mb-1"><span className={`traffic-light ${results.kpi.runway?.status==='good'?'bg-success':results.kpi.runway?.status==='warning'?'bg-accent':'bg-danger'}`}></span><span className="text-xs text-slate-500 font-bold uppercase">{t.cashRunway}</span></div>
                            <div className="text-2xl font-bold text-slate-700">{results.runwayMonths?.toFixed(1)} <span className="text-sm font-normal text-slate-400">{t.months}</span></div>
                        </div>
                        <div className="card p-4 flex flex-col justify-between border-t-4 border-blue-500">
                            <div className="flex items-center gap-2 mb-1"><span className="traffic-light bg-blue-500"></span><span className="text-xs text-slate-500 font-bold uppercase">{t.payback}</span></div>
                            <div className="text-2xl font-bold text-slate-700">{results.paybackPeriod === Infinity ? 'N/A' : results.paybackPeriod?.toFixed(1)} <span className="text-sm font-normal text-slate-400">{t.months}</span></div>
                        </div>
                        <div className="card p-4 flex flex-col justify-between border-t-4 border-purple-500">
                            <div className="flex items-center gap-2 mb-1"><span className="traffic-light bg-purple-500"></span><span className="text-xs text-slate-500 font-bold uppercase">{t.totalRoas}</span></div>
                            <div className="text-2xl font-bold text-slate-700">{results.marketing.totalROAS?.toFixed(1)}x</div>
                        </div>
                        <div className="card p-4 flex flex-col justify-between border-t-4 border-indigo-500">
                             <div className="flex items-center gap-2 mb-1"><span className="traffic-light bg-indigo-500"></span><span className="text-xs text-slate-500 font-bold uppercase">{t.unitEcon}</span></div>
                             <div className="text-xl font-bold text-slate-700">{formatCurrency(results.unitEconomics.sales)}</div>
                             <div className="text-[10px] text-slate-400 mt-1">{t.rentPerDeal}: {formatCurrency(results.unitEconomics.rental)}/{t.deal}</div>
                        </div>
                    </div>

                    <div className="max-w-7xl mx-auto px-4 grid grid-cols-1 xl:grid-cols-12 gap-6">
                        <div className="xl:col-span-3 space-y-5 no-print">
                            <div className="card p-5">
                                <h3 className="card-title mb-4 border-b pb-2 flex justify-between">
                                    <span className="flex gap-2"><Icon path={icons.settings} size={16} className="text-slate-400"/> {t.scenarioAnalysis}</span>
                                </h3>
                                <div className="grid grid-cols-3 gap-1 mb-4">
                                    <button onClick={() => applyScenario('worst')} className="text-[10px] py-1 bg-red-100 text-red-700 rounded hover:bg-red-200">{t.worst}</button>
                                    <button onClick={() => applyScenario('base')} className="text-[10px] py-1 bg-slate-200 text-slate-700 rounded hover:bg-slate-300">{t.baseCase}</button>
                                    <button onClick={() => applyScenario('best')} className="text-[10px] py-1 bg-emerald-100 text-emerald-700 rounded hover:bg-emerald-200">{t.best}</button>
                                </div>
                                <div className="space-y-4">
                                    {[{l: t.salesVolAdj, n:'sensSalesVol',min:-50,max:50,step:5},{l: t.adBudgetAdj, n:'sensAdBudget',min:-50,max:100,step:10},{l: t.vatRateAdj, n:'sensVatRate',min:0,max:10,step:1}].map(f=>(
                                        <div key={f.n}><div className="flex justify-between text-xs mb-1 text-slate-600"><span>{f.l}</span><span className="font-bold">{inputs[f.n]}%</span></div><input type="range" name={f.n} min={f.min} max={f.max} step={f.step} value={inputs[f.n]} onChange={handleInputChange} className="w-full h-1.5 bg-slate-200 rounded-lg cursor-pointer accent-secondary"/></div>
                                    ))}
                                </div>
                            </div>
                            <div className="card p-5">
                                <h3 className="card-title mb-3 border-b pb-2"><Icon path={icons.briefcase} size={16} className="text-slate-400"/> {t.capex}</h3>
                                <div className="flex justify-between items-center mb-2"><label className="text-xs font-bold text-slate-700">{t.initialCapital}</label><input type="number" name="initialCapital" value={inputs.initialCapital} onChange={handleInputChange} className="w-24 border rounded px-2 py-1 text-right text-xs bg-slate-50 focus:outline-none focus:ring-1 focus:ring-primary font-bold text-slate-800"/></div>
                                <div className="h-px bg-slate-100 my-2"></div>
                                {capexItems.map(i=><div key={i.name} className="flex justify-between items-center mb-2"><label className="text-xs text-slate-500">{t[i.label]}</label><input type="number" name={i.name} value={inputs[i.name]} onChange={handleInputChange} className="w-24 border rounded px-2 py-1 text-right text-xs bg-slate-50 focus:outline-none focus:ring-1 focus:ring-primary"/></div>)}
                                {/* FIXED: Added Total CAPEX */}
                                <div className="pt-3 border-t mt-2 space-y-1">
                                    <div className="flex justify-between text-xs text-slate-500"><span>{t.totalCapex}:</span><span className="font-bold text-slate-700">({formatCurrency(results.totalCapex)})</span></div>
                                    <div className="flex justify-between text-xs font-bold text-emerald-700"><span>{t.workingCapital}:</span><span>{formatCurrency(results.workingCapital)}</span></div>
                                </div>
                            </div>
                            <div className="card p-5">
                                <div className="flex justify-between items-center mb-4 border-b pb-2"><h3 className="card-title"><Icon path={icons.home} size={16} className="text-slate-400"/> {t.revenue}</h3><button onClick={toggleVatMode} className={`text-[10px] px-2 py-1 rounded font-bold transition-colors ${inputs.vatMode==='include'?'bg-primary text-white':'bg-slate-200 text-slate-600'}`}>{t.vatMode} {inputs.vatMode==='include'? t.vatInc : t.vatExc}</button></div>
                                <div className="space-y-4">
                                    <div className="bg-slate-50 p-3 rounded-lg border border-slate-100"><div className="flex justify-between text-xs mb-2 font-bold text-accent"><span>{t.sales}</span><span>{inputs.salesVolume} {t.unitMo}</span></div><input type="range" name="salesVolume" min="0" max="10" step="0.5" value={inputs.salesVolume} onChange={handleInputChange} className="w-full h-1.5 bg-slate-200 rounded-lg cursor-pointer accent-accent mb-3"/><div className="flex gap-2"><div className="w-full"><label className="text-[9px] text-slate-400 block mb-0.5">{t.price}</label><input type="number" name="avgHousePrice" value={inputs.avgHousePrice} onChange={handleInputChange} className="w-full border rounded px-1 py-1 text-xs outline-none focus:ring-1 focus:ring-accent" /></div><div className="w-16"><label className="text-[9px] text-slate-400 block mb-0.5">{t.commPct}</label><input type="number" name="salesCommRate" value={inputs.salesCommRate} onChange={handleInputChange} className="w-full border rounded px-1 py-1 text-xs text-center outline-none focus:ring-1 focus:ring-accent" /></div></div></div>
                                    <div className="bg-slate-50 p-3 rounded-lg border border-slate-100"><div className="flex justify-between text-xs mb-2 font-bold text-primary"><span>{t.rentals}</span><span>{inputs.rentalVolume} {t.caseMo}</span></div><input type="range" name="rentalVolume" min="0" max="20" step="1" value={inputs.rentalVolume} onChange={handleInputChange} className="w-full h-1.5 bg-slate-200 rounded-lg cursor-pointer accent-primary mb-3"/><div className="flex gap-2"><div className="w-full"><label className="text-[9px] text-slate-400 block mb-0.5">{t.price}</label><input type="number" name="avgRentalPrice" value={inputs.avgRentalPrice} onChange={handleInputChange} className="w-full border rounded px-1 py-1 text-xs outline-none focus:ring-1 focus:ring-primary" /></div><div className="w-16"><label className="text-[9px] text-slate-400 block mb-0.5">{t.commMo}</label><input type="number" name="rentalCommMonths" value={inputs.rentalCommMonths} onChange={handleInputChange} className="w-full border rounded px-1 py-1 text-xs text-center outline-none focus:ring-1 focus:ring-primary" /></div></div></div>
                                    <div className="bg-slate-50 p-3 rounded-lg border border-slate-100"><div className="flex justify-between text-xs mb-2 font-bold text-purple-600"><span>{t.propMgmt}</span><span>{inputs.pmUnits} {t.units}</span></div><div className="flex gap-2 items-center"><label className="text-[9px] text-slate-400">{t.units}</label><input type="number" name="pmUnits" value={inputs.pmUnits} onChange={handleInputChange} className="w-16 border rounded px-1 py-1 text-xs" /><label className="text-[9px] text-slate-400">{t.feeMo}</label><input type="number" name="pmFeePerUnit" value={inputs.pmFeePerUnit} onChange={handleInputChange} className="w-full border rounded px-1 py-1 text-xs" /></div></div>
                                </div>
                            </div>
                             <div className="card p-5">
                                <h3 className="card-title mb-3 border-b pb-2"><Icon path={icons.users} size={16} className="text-slate-400"/> {t.costsStaff}</h3>
                                {staffRoles.map(r=><div key={r.id} className="grid grid-cols-12 gap-1 items-center mb-2"><div className="col-span-5 text-xs text-slate-600">{t[r.label]}</div><div className="col-span-3"><input type="number" name={r.rateKey} value={inputs[r.rateKey]} onChange={handleInputChange} className="w-full border rounded px-1 py-1 text-[10px] text-right bg-slate-50"/></div><div className="col-span-2"><input type="number" name={r.countKey} value={inputs[r.countKey]} onChange={handleInputChange} className="w-full border rounded px-1 py-1 text-[10px] text-center bg-slate-50"/></div><div className="col-span-2 text-[10px] text-right font-bold text-slate-700">{formatCurrency(inputs[r.rateKey]*inputs[r.countKey]).replace('฿','')}</div></div>)}
                                <div className="h-px bg-slate-100 my-3"></div>
                                <div className="flex justify-between items-center mb-2"><label className="text-xs font-bold text-primary">{t.adsBudget}</label><input type="number" name="marketingBudget" value={inputs.marketingBudget} onChange={handleInputChange} className="w-24 border border-blue-200 text-blue-900 font-bold rounded px-2 py-1 text-xs text-right bg-blue-50" /></div>
                                <div className="flex justify-between items-center mb-2"><label className="text-xs text-slate-600">{t.officeRent}</label><input type="number" name="officeRent" value={inputs.officeRent} onChange={handleInputChange} className="w-24 border rounded px-2 py-1 text-xs text-right bg-slate-50" /></div>
                                <div className="flex justify-between items-center mb-2"><label className="text-xs text-slate-600">{t.software}</label><input type="number" name="softwareCost" value={inputs.softwareCost} onChange={handleInputChange} className="w-24 border rounded px-2 py-1 text-xs text-right bg-slate-50" /></div>
                                <div className="flex justify-between items-center"><label className="text-xs text-slate-600">{t.other}</label><input type="number" name="otherExpenses" value={inputs.otherExpenses} onChange={handleInputChange} className="w-24 border rounded px-2 py-1 text-xs text-right bg-slate-50" /></div>
                            </div>
                            <div className="card p-5">
                                <h3 className="card-title mb-3 border-b pb-2"><Icon path={icons.settings} size={16} className="text-slate-400"/> {t.commissionPct}</h3>
                                {['shareSales','shareListing','shareManager','shareContent','shareAdmin'].map(k=><div key={k} className="flex justify-between items-center mb-2"><label className="text-xs capitalize text-slate-600">{t[k.replace('share','').toLowerCase()]}</label><div className="flex items-center"><input type="number" name={k} value={inputs[k]} onChange={handleInputChange} className="w-12 border rounded text-center text-xs bg-slate-50 py-1 mr-1"/>%</div></div>)}
                                <div className="border-t pt-2 flex justify-between font-bold text-slate-800 text-xs mt-2"><span>{t.companyAuto}</span><span>{results.companySharePercent.toFixed(1)}%</span></div>
                            </div>
                        </div>

                        <div className="xl:col-span-5 space-y-6">
                            <div className="card p-6">
                                <h4 className="card-title mb-5"><Icon path={icons.fileText} size={16} className="text-slate-400"/> {t.revenueFlow}</h4>
                                <div className="space-y-6 relative pl-5 border-l-2 border-slate-100">
                                    <div className="relative"><div className="absolute -left-[27px] top-1 w-4 h-4 bg-slate-300 rounded-full border-4 border-white"></div><div className="flex justify-between text-sm"><span className="text-slate-500">{t.totalGross}</span><span className="font-bold text-slate-800">{formatCurrency(results.totalGross)}</span></div></div>
                                    <div className="relative"><div className="absolute -left-[27px] top-1 w-4 h-4 bg-danger rounded-full border-4 border-white"></div><div className="flex justify-between text-sm text-danger"><span className="flex items-center gap-1">{t.deductVat} (7%)</span><span>({formatCurrency(results.vatAmount)})</span></div></div>
                                    <div className="relative"><div className="absolute -left-[27px] top-1 w-4 h-4 bg-primary rounded-full border-4 border-white"></div><div className="flex justify-between text-sm mb-3"><span className="font-bold text-primary">{t.netRevenue}</span><span className="font-bold text-primary">{formatCurrency(results.netRevenue)}</span></div>
                                        <div className="grid grid-cols-2 gap-2 text-[10px]">
                                            <div className="bg-slate-50 p-2 rounded border border-slate-200"><div className="flex justify-between mb-1 text-slate-600"><span>{t.companyShare} ({results.companySharePercent.toFixed(1)}%)</span><b>{formatCurrency(results.distCompany)}</b></div><div className="h-1.5 bg-slate-200 rounded-full overflow-hidden"><div className="h-full bg-slate-800" style={{width: `${results.companySharePercent}%`}}></div></div></div>
                                            <div className="bg-amber-50 p-2 rounded border border-amber-100"><div className="flex justify-between mb-1 text-amber-700"><span>Sales ({inputs.shareSales}%)</span><b>{formatCurrency(results.distSales)}</b></div><div className="h-1.5 bg-amber-200 rounded-full overflow-hidden"><div className="h-full bg-amber-500" style={{width: `${inputs.shareSales}%`}}></div></div></div>
                                            <div className="bg-blue-50 p-2 rounded border border-blue-100"><div className="flex justify-between mb-1 text-blue-700"><span>Listing ({inputs.shareListing}%)</span><b>{formatCurrency(results.distListing)}</b></div><div className="h-1.5 bg-blue-200 rounded-full overflow-hidden"><div className="h-full bg-blue-500" style={{width: '60%'}}></div></div></div>
                                            <div className="bg-purple-50 p-2 rounded border border-purple-100"><div className="flex justify-between mb-1 text-purple-700"><span>Manager ({inputs.shareManager}%)</span><b>{formatCurrency(results.distManager)}</b></div><div className="h-1.5 bg-purple-200 rounded-full overflow-hidden"><div className="h-full bg-purple-500" style={{width: '60%'}}></div></div></div>
                                            <div className="bg-pink-50 p-2 rounded border border-pink-100"><div className="flex justify-between mb-1 text-pink-700"><span>Content ({inputs.shareContent}%)</span><b>{formatCurrency(results.distContent)}</b></div><div className="h-1.5 bg-pink-200 rounded-full overflow-hidden"><div className="h-full bg-pink-500" style={{width: '60%'}}></div></div></div>
                                            <div className="bg-indigo-50 p-2 rounded border border-indigo-100"><div className="flex justify-between mb-1 text-indigo-700"><span>Admin ({inputs.shareAdmin}%)</span><b>{formatCurrency(results.distAdmin)}</b></div><div className="h-1.5 bg-indigo-200 rounded-full overflow-hidden"><div className="h-full bg-indigo-500" style={{width: '60%'}}></div></div></div>
                                        </div>
                                    </div>
                                    <div className="relative pt-4 border-t border-dashed mt-2"><div className="absolute -left-[27px] top-5 w-4 h-4 bg-success rounded-full border-4 border-white"></div><div className="flex justify-between text-xs text-slate-600 mb-1"><span>{t.companyShare}:</span><b>{formatCurrency(results.distCompany)}</b></div><div className="flex justify-between text-xs text-danger mb-2"><span>{t.totalExpenses}:</span><b>({formatCurrency(results.totalExpenses)})</b></div><div className="flex justify-between text-base font-bold text-success mt-2 pt-2 border-t border-slate-100"><span>{t.monthlyNetProfit}</span><span>{formatCurrency(results.monthlyEBT)}</span></div></div>
                                </div>
                            </div>
                            
                            <div className="card overflow-hidden">
                                <div className="card-header">
                                    <h4 className="card-title"><Icon path={icons.building2} size={16} className="text-slate-500"/> {t.corpTax}</h4>
                                    <div className="text-xs font-semibold bg-emerald-100 text-emerald-700 px-2 py-1 rounded">{t.ebt}: {formatCurrency(results.annualEBT)}</div>
                                </div>
                                <div className="p-0">
                                    <table className="w-full text-sm">
                                        <thead className="bg-slate-50 text-slate-500 text-xs uppercase">
                                            <tr><th className="py-3 pl-6 text-left font-medium">{t.netProfitRange}</th><th className="py-3 text-center font-medium">{t.rate}</th><th className="py-3 pr-6 text-right font-medium">{t.taxPayable}</th></tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-100">
                                            {results.taxDetails.map((item, index) => (
                                                <tr key={index} className="hover:bg-slate-50 transition-colors">
                                                    <td className="py-3 pl-6 text-slate-600">{item.tier}</td><td className="py-3 text-center"><span className="bg-slate-100 text-slate-600 px-2 py-0.5 rounded text-xs font-bold">{item.rate}</span></td><td className="py-3 pr-6 text-right font-medium text-slate-800">{formatCurrency(item.tax)}</td>
                                                </tr>
                                            ))}
                                            <tr className="bg-slate-50"><td className="py-3 pl-6 font-bold text-slate-800" colSpan="2">{t.totalTax}</td><td className="py-3 pr-6 text-right font-bold text-danger">{formatCurrency(results.totalTax)}</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <div className="card p-6">
                                <h4 className="card-title mb-5"><Icon path={icons.target} size={16} className="text-primary"/> {t.marketingFunnel}</h4>
                                <div className="mb-5 bg-slate-50 p-4 rounded-xl border border-slate-200">
                                    <div className="flex justify-between text-xs font-bold mb-2">
                                        <span className="text-accent">{t.salesBudget} {inputs.marketingSplitPct}%</span>
                                        <span className="text-slate-600">{formatCurrency(results.marketing.sales?.budget)} | {formatCurrency(results.marketing.rent?.budget)}</span>
                                        <span className="text-primary">{t.rentBudget} {100-inputs.marketingSplitPct}%</span>
                                    </div>
                                    <input type="range" name="marketingSplitPct" min="0" max="100" step="5" value={inputs.marketingSplitPct} onChange={handleInputChange} className="w-full h-2 bg-gradient-to-r from-amber-400 to-slate-800 rounded-lg cursor-pointer appearance-none"/>
                                </div>
                                <div className="grid grid-cols-2 gap-6">
                                    <div className="space-y-3">
                                        <h5 className="text-[10px] font-bold text-accent uppercase border-b border-amber-100 pb-1">{t.salesSide}</h5>
                                        <div className="flex justify-between text-[10px] items-center"><label class="text-slate-500">{t.cpl}</label><input type="number" name="cplSale" value={inputs.cplSale} onChange={handleInputChange} className="w-14 border rounded text-right px-1 bg-amber-50"/></div>
                                        <div className="flex justify-between text-[10px] items-center"><label class="text-slate-500">{t.convRate}</label><input type="number" name="closeRateSale" value={inputs.closeRateSale} onChange={handleInputChange} className="w-12 border rounded text-right px-1 bg-amber-50"/></div>
                                        <div className="bg-amber-50 p-3 rounded-lg text-[10px] space-y-1.5 border border-amber-100">
                                            <div className="flex justify-between"><span>{t.leads}:</span><b>{parseInt(results.marketing.sales?.leads)}</b></div>
                                            <div className="flex justify-between"><span>{t.closed}:</span><b>{results.marketing.sales?.closed?.toFixed(1)}</b></div>
                                            <div className="flex justify-between text-accent font-bold border-t border-amber-200 pt-1 mt-1"><span>{t.roas}:</span><span>{results.marketing.sales?.roas?.toFixed(1)}x</span></div>
                                        </div>
                                    </div>
                                    <div className="space-y-3">
                                        <h5 className="text-[10px] font-bold text-primary uppercase border-b border-slate-200 pb-1">{t.rentSide}</h5>
                                        <div className="flex justify-between text-[10px] items-center"><label class="text-slate-500">{t.cpl}</label><input type="number" name="cplRent" value={inputs.cplRent} onChange={handleInputChange} className="w-14 border rounded text-right px-1 bg-slate-50"/></div>
                                        <div className="flex justify-between text-[10px] items-center"><label class="text-slate-500">{t.convRate}</label><input type="number" name="closeRateRent" value={inputs.closeRateRent} onChange={handleInputChange} className="w-12 border rounded text-right px-1 bg-slate-50"/></div>
                                        <div className="bg-slate-50 p-3 rounded-lg text-[10px] space-y-1.5 border border-slate-200">
                                            <div className="flex justify-between"><span>{t.leads}:</span><b>{parseInt(results.marketing.rent?.leads)}</b></div>
                                            <div className="flex justify-between"><span>{t.closed}:</span><b>{results.marketing.rent?.closed?.toFixed(1)}</b></div>
                                            <div className="flex justify-between text-primary font-bold border-t border-slate-200 pt-1 mt-1"><span>{t.roas}:</span><span>{results.marketing.rent?.roas?.toFixed(1)}x</span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="xl:col-span-4 space-y-6">
                            <div className="card p-5 h-64 flex flex-col">
                                <h4 className="card-title mb-2"><Icon path={icons.pieChart} size={16} className="text-slate-400"/> {t.netIncomeMix}</h4>
                                <div className="flex-1 flex items-center">
                                    <div className="w-1/2 h-full"><ResponsiveContainer><PieChart><Pie data={revenuePieData} innerRadius={35} outerRadius={50} paddingAngle={5} dataKey="value" stroke="none">{revenuePieData.map((e,i)=><Cell key={i} fill={COLORS.revenue[i]}/>)}</Pie><Tooltip formatter={formatCurrency}/></PieChart></ResponsiveContainer></div>
                                    {/* FIXED: Added % calculation */}
                                    <div className="w-1/2 text-xs space-y-2">{revenuePieData.map((e,i)=><div key={i}><div className="flex items-center gap-1"><div className="w-2 h-2 rounded-full" style={{background:COLORS.revenue[i]}}></div><span className="text-slate-500">{e.name}</span></div><div className="pl-3 font-bold text-slate-700">{formatCurrency(e.value)} <span className="text-slate-400 font-normal ml-1">({(results.netRevenue * (results.companySharePercent/100)) > 0 ? ((e.value / (results.netRevenue * (results.companySharePercent/100))) * 100).toFixed(0) : 0}%)</span></div></div>)}</div>
                                </div>
                            </div>
                            <div className="card p-5 h-72 flex flex-col">
                                <h4 className="card-title mb-2"><Icon path={icons.pieChart} size={16} className="text-slate-400"/> {t.expenseSplit}</h4>
                                <div className="flex-1 flex items-center">
                                    <div className="w-1/2 h-full"><ResponsiveContainer><PieChart><Pie data={expensePieData} innerRadius={40} outerRadius={60} paddingAngle={5} dataKey="value" stroke="none">{expensePieData.map((e,i)=><Cell key={i} fill={COLORS.chart[i%COLORS.chart.length]}/>)}</Pie><Tooltip formatter={formatCurrency}/></PieChart></ResponsiveContainer></div>
                                    <div className="w-1/2 text-xs space-y-2 overflow-y-auto max-h-full custom-scrollbar pr-2">{expensePieData.map((e,i)=><div key={i}><div className="flex items-center gap-1"><div className="w-2 h-2 rounded-full" style={{background:COLORS.chart[i%COLORS.chart.length]}}></div><span className="truncate text-slate-500">{e.name}</span></div><div className="pl-3 font-bold text-slate-700">{formatCurrency(e.value)} <span className="text-slate-400 font-normal">({((e.value/Math.max(1,results.totalExpenses))*100).toFixed(0)}%)</span></div></div>)}</div>
                                </div>
                            </div>
                            
                            {/* Break Even Summary Card */}
                            <div className="card p-5">
                                <h4 className="card-title mb-3 border-b pb-2"><Icon path={icons.refreshCw} size={16} className="text-accent"/> {t.breakeven}</h4>
                                <div className="text-center py-4 bg-slate-50 rounded-lg border border-slate-200 mb-3">
                                    <div className="text-xs text-slate-500 mb-1">{t.minRevenue}</div>
                                    <div className="text-2xl font-bold text-accent">{formatCurrency(results.breakEvenPoint)}</div>
                                </div>
                                <div className="space-y-2 text-xs">
                                    <div className="flex justify-between items-center p-2 bg-slate-50 rounded border border-slate-100">
                                        <span className="text-slate-600">{t.mustSell}:</span>
                                        <span className="font-bold text-slate-800">{Math.ceil(results.breakEvenPoint / inputs.avgHousePrice)} {t.unitMo}</span>
                                    </div>
                                    <div className="flex justify-between items-center p-2 bg-slate-50 rounded border border-slate-100">
                                        <span className="text-slate-600">{t.mustRent}:</span>
                                        <span className="font-bold text-slate-800">{Math.ceil(results.breakEvenPoint / (inputs.avgRentalPrice * inputs.rentalCommMonths))} {t.caseMo}</span>
                                    </div>
                                </div>
                            </div>

                            <div className="card p-5 h-64">
                                <h4 className="card-title mb-2"><Icon path={icons.refreshCw} size={16} className="text-slate-400"/> Break-even Tracker</h4>
                                <ResponsiveContainer><ComposedChart data={bepChartData}><CartesianGrid strokeDasharray="3 3" vertical={false}/><XAxis dataKey="month" tick={{fontSize:10}}/><YAxis tickFormatter={(v)=>`${v/1000}k`} tick={{fontSize:10}} width={30}/><Tooltip formatter={formatCurrency}/><Area type="monotone" dataKey="revenue" name="รายได้สะสม" fill="#e2e8f0" stroke="#334155"/><Line type="monotone" dataKey="expenses" name="รายจ่ายสะสม" stroke="#dc2626" strokeWidth={2} dot={false}/></ComposedChart></ResponsiveContainer>
                            </div>
                        </div>
                    </div>

                    <div className="max-w-7xl mx-auto px-4 sm:px-6 mb-6">
                        <div className="card overflow-hidden">
                             <div className="card-header">
                                <h4 className="card-title"><Icon path={icons.table} size={16} className="text-slate-400"/> {t.cashFlow12}</h4>
                                <div className="flex items-center gap-1 text-xs"><Icon path={icons.trendingUp} size={12} className="text-success"/><select name="growthRate" value={inputs.growthRate} onChange={handleInputChange} className="bg-transparent font-bold outline-none text-slate-700"><option value="0">โต 0%</option><option value="5">โต 5%</option><option value="10">โต 10%</option></select></div>
                            </div>
                            <div className="overflow-x-auto p-0">
                                <table className="w-full text-xs text-right border-collapse">
                                    <thead className="bg-slate-50 text-slate-600 font-medium border-b border-slate-200"><tr><th className="py-3 px-3 text-center">{t.month}</th><th className="px-3">{t.netIn}</th><th className="px-3">{t.exp}</th><th className="px-3">{t.profit}</th><th className="px-3">{t.tax}</th><th className="px-3 text-success">{t.netP}</th><th className="px-3 text-primary">{t.cash}</th></tr></thead>
                                    <tbody className="divide-y divide-slate-100">
                                        <tr className="bg-slate-50 italic text-slate-400"><td className="text-center py-2">{t.start}</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td className="pr-3 font-bold text-slate-600">{formatCurrency(results.workingCapital)}</td></tr>
                                        {cashFlowData.map((row, i) => (
                                            <tr key={i} className="hover:bg-slate-50">
                                                <td className="text-center py-2 text-slate-500">{row.month}</td>
                                                <td className="text-success font-medium">{formatCurrency(row.revenue)}</td>
                                                <td className="text-danger">{formatCurrency(row.expenses)}</td>
                                                <td className="text-slate-600">{formatCurrency(row.net)}</td>
                                                <td className="text-slate-300">-</td>
                                                <td className="font-bold text-slate-700">{formatCurrency(row.net)}</td>
                                                <td className="pr-2 font-bold text-primary">{formatCurrency(row.cumulative)}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                    <tfoot className="bg-slate-50 border-t-2 border-slate-200 font-bold text-slate-800">
                                        <tr><td className="py-3 text-center">{t.totalY1}</td><td className="text-success">{formatCurrency(results.year1RevenueSum)}</td><td className="text-danger">{formatCurrency(results.year1ExpenseSum)}</td><td className="text-primary">{formatCurrency(results.annualEBT)}</td><td className="text-danger">({formatCurrency(results.totalTax)})</td><td className="text-success">{formatCurrency(results.annualNetProfit)}</td><td className="pr-2 text-primary">{formatCurrency(results.finalCashBalance)}</td></tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div className="max-w-7xl mx-auto px-4 sm:px-6 mb-6">
                        <div className="card p-5">
                            <div className="flex justify-between items-center mb-4 border-b pb-2">
                                 <h4 className="card-title text-sm flex gap-2"><Icon path={icons.banknote} size={16} className="text-success"/> {t.dividendPolicy}</h4>
                                 <div className="flex items-center gap-2">
                                     <span className="text-xs font-bold text-slate-600">{t.payout}: {inputs.dividendRate}%</span>
                                     <input type="range" name="dividendRate" min="0" max="100" step="5" value={inputs.dividendRate} onChange={handleInputChange} className="w-24 h-1.5 bg-slate-200 rounded-lg cursor-pointer accent-success"/>
                                 </div>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                                <div className="p-4 bg-emerald-50 rounded-xl border border-emerald-100">
                                    <div className="text-xs text-emerald-700 mb-1 font-bold uppercase tracking-wide">{t.totalDiv}</div>
                                    <div className="text-2xl font-bold text-emerald-800">{formatCurrency(results.dividends.total)}</div>
                                    <div className="text-[10px] text-emerald-600 mt-1">{t.paidFromY1}</div>
                                </div>
                                <div className="p-4 bg-blue-50 rounded-xl border border-blue-100">
                                    <div className="text-xs text-blue-700 mb-1 font-bold uppercase tracking-wide">{t.founderShare}</div>
                                    <div className="text-2xl font-bold text-blue-800">{formatCurrency(results.dividends.perFounderYear)}</div>
                                    <div className="text-[10px] text-blue-600 mt-1">{t.for2Founders}</div>
                                </div>
                                <div className="p-4 bg-indigo-50 rounded-xl border border-indigo-100">
                                    <div className="text-xs text-indigo-700 mb-1 font-bold uppercase tracking-wide">{t.monthlyAvg}</div>
                                    <div className="text-2xl font-bold text-indigo-800">{formatCurrency(results.dividends.perFounderMonth)}</div>
                                    <div className="text-[10px] text-indigo-600 mt-1">{t.sideIncome}</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="max-w-7xl mx-auto px-4 sm:px-6 mb-10">
                        <div className="card overflow-hidden">
                            <div className="card-header bg-primary border-none">
                                <h3 className="card-title text-white"><Icon path={icons.trendingUp} size={18} className="text-accent"/> {t.projection5Y}</h3>
                                <div className="flex items-center gap-4 text-xs text-white">
                                    <div className="flex items-center gap-1"><span>{t.inflation}:</span><select name="inflationRate" value={inputs.inflationRate} onChange={handleInputChange} className="bg-slate-700 rounded px-1 outline-none text-white cursor-pointer"><option value="3">3%</option><option value="5">5%</option><option value="7">7%</option></select></div>
                                    <div className="flex items-center gap-1"><span>{t.growth}:</span><select name="annualGrowthRate" value={inputs.annualGrowthRate} onChange={handleInputChange} className="bg-slate-700 rounded px-1 outline-none text-white cursor-pointer"><option value="10">10%</option><option value="15">15%</option><option value="20">20%</option></select></div>
                                </div>
                            </div>
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm text-right">
                                    <thead className="bg-slate-50 text-slate-500 text-xs uppercase border-b border-slate-200"><tr><th className="px-4 py-3 text-left">{t.year}</th><th className="px-4">{t.revenue5y}</th><th className="px-4">{t.expense5y}</th><th className="px-4">{t.ebt5y}</th><th className="px-4">{t.tax5y}</th><th className="px-4 text-success">{t.net5y}</th><th className="px-4 text-danger">{t.div5y}</th><th className="px-4 text-primary">{t.cashEnd}</th></tr></thead>
                                    <tbody className="divide-y divide-slate-100">
                                        {fiveYearData.map((y, i) => (
                                            <tr key={y.year} className="hover:bg-slate-50">
                                                <td className="px-4 py-3 text-left font-medium text-slate-700">Y{y.year} {i===0 && <span className="text-[10px] bg-slate-200 px-1 rounded ml-1 text-slate-500 font-normal">{t.base}</span>}</td>
                                                <td className="px-4">{formatCurrency(y.revenue)}</td><td className="px-4 text-slate-500">{formatCurrency(y.expenses)}</td><td className="px-4 font-medium">{formatCurrency(y.ebt)}</td><td className="px-4 text-danger">({formatCurrency(y.tax)})</td><td className="px-4 font-bold text-success bg-emerald-50/30">{formatCurrency(y.netProfit)}</td><td className="px-4 text-danger">({formatCurrency(y.dividend)})</td><td className="px-4 font-bold text-primary bg-blue-50/30">{formatCurrency(y.cashEnd)}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                                <div className="bg-slate-50 px-4 py-2 text-xs text-slate-400 text-right border-t border-slate-200">
                                    {t.assumptions}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<FinancialDashboard />);
    </script>
</body>
</html>
